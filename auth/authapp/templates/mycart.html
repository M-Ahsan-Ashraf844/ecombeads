{% include 'Navbar.html' %}
{% load static %}
{% if messages %}
<div id="success-message" class="fixed top-20 left-1/2 transform -translate-x-1/2 
        bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg 
        flex items-center gap-3 animate-slide-down 
        z-[9999] max-w-xs w-auto">
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
</div>
{% endif %}

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">Your Shopping Cart</h1>
<a href="{% url 'home' %}" class="flex text-red-500 pb-6" >
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-6 w-6 text-red-500" 
         fill="none" viewBox="0 0 24 24" 
         stroke="currentColor">
        <path stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2" 
              d="M15 19l-7-7 7-7" />
    </svg>back to home
</a>
    {% if cart_items %}
    <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">

        <!-- Cart Items Section -->
        <div class="flex-1 bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Your Cart</h2>
                <p class="text-gray-500 mt-1">{{ cart_items|length }} item{{ cart_items|length|pluralize }}</p>
            </div>

            <div class="divide-y">
                {% for item in cart_items %}
                <div class="flex flex-col sm:flex-row items-center justify-between p-4 hover:bg-gray-50 transition">
                    <!-- Product Info -->
                    <div class="flex items-center space-x-4 flex-1">
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                             class="w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-lg shadow-sm hover:scale-105 transition">
                        <div>
                            <h3 class="font-semibold text-gray-800">{{ item.product.name }}{% if item.size %} <p class="text-white w-20 text-center bg-pink-500 rounded">size {{item.size}}</p>{%endif%} {% if item.beads_name %} <p class="text-white w-40 text-center bg-pink-500 rounded">Name: {{item.beads_name}}</p>{%endif%}</h3>
                            <p class="text-gray-500 sm:hidden">{{ item.product.discounted_price }}</p>
                        </div>
                    </div>

                    <!-- Price (Desktop) -->
                    <div class="hidden sm:flex justify-center w-24 text-gray-700 font-medium">{{ item.product.discounted_price }}</div>

                    <!-- Quantity Selector -->
                    <div class="flex items-center justify-center mt-2 sm:mt-0 space-x-2">
                        <button type="button" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 decrease" 
                                data-product-id="{{ item.product.id }}">-</button>
                        <input type="number" value="{{ item.quantity }}" min="1"
                               class="w-12 text-center border rounded-lg px-2 py-1 quantity-input" 
                               data-product-id="{{ item.product.id }}">
                        <button type="button" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 rounded px-2 py-1 increase" 
                                data-product-id="{{ item.product.id }}">+</button>
                    </div>

                    <!-- Total -->
                    <div class="hidden sm:flex justify-center w-24 font-semibold text-gray-900 item-total">{{ item.totalprice }}</div>

                    <!-- Remove Button -->
                    <div class="mt-2 sm:mt-0 sm:ml-4 text-red-500 hover:text-red-700">
                        <form action="{% url 'removecart' item.product.id %}" method="POST">
                            {% csrf_token %}
                           <button type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" 
     class="h-6 w-6 text-red-500 hover:text-red-700 cursor-pointer" 
     fill="none" 
     viewBox="0 0 24 24" 
     stroke="currentColor">
  <path stroke-linecap="round" 
        stroke-linejoin="round" 
        stroke-width="2" 
        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M8 7V4a1 1 0 011-1h6a1 1 0 011 1v3"/>
</svg>


                           </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Checkout Section -->
        <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-lg p-6 flex flex-col space-y-6 lg:sticky lg:top-6">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-2">Order Summary</h3>

            <div class="flex justify-between text-gray-700 font-medium">
                <span>Subtotal</span>
                <span id="grandTotal">0.00</span>
            </div>

            <div class="flex justify-between text-gray-700 font-medium">
                <span>Shipping</span>
                <span>+250 Delivery Charges</span>
            </div>

            <div class="border-t pt-4 flex justify-between text-lg font-bold text-gray-900">
                <span>Total</span>
                <span id="grandTotalFinal">0.00</span>
            </div>

            <form action="{% url 'checkout' %}" method="post" class="mt-4 flex flex-col gap-2">
                {% csrf_token %}
                 <div>
          <label for="full_name" class="block text-sm font-medium text-gray-700 mb-1">full_name</label>
          <input type="full_name" id="full_name" name="full_name" required
                 class="w-full rounded-xl border border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label for="contact" class="block text-sm font-medium text-gray-700 mb-1">Contact No</label>
          <input type="number" id="contact" name="contact" required
                 class="w-full rounded-xl border border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Shipping Address</label>
          <textarea id="address" name="address" rows="3" required
                    class="w-full rounded-xl border border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
        </div>
        <div>
          <label for="customer_city" class="block text-sm font-medium text-gray-700 mb-1">city</label>
          <input type="customer_city" id="customer_city" name="customer_city" required
                 class="w-full rounded-xl border border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
  <label class="block text-gray-700 font-medium mb-1">Province</label>
  <select name="customer_province" required
          class="w-full rounded-lg border-gray-300 bg-white px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">

    <option value="" disabled selected>Select Province</option>

    <option value="punjab">Punjab</option>
    <option value="sindh">Sindh</option>
    <option value="balochistan">Balochistan</option>
    <option value="kpk">KPK</option>
    <option value="gilgit">Gilgit</option>
    <option value="islamabad">Islamabad</option>

  </select>
</div>

                <button type="submit" class="w-full mt-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 rounded-lg shadow">
                    Proceed to Checkout
                </button>
            </form>

            <a href="{% url 'home' %}" class="text-center text-blue-600 hover:underline mt-2">Continue Shopping</a>
        </div>
    </div>
    {% else %}
    <p>your cart is empty</p>
    {% endif %}
</div>

<!-- JS for Real-Time Updates -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    const cartItems = document.querySelectorAll('.quantity-input');

    function updateTotals() {
        let grandTotal = 0;
        cartItems.forEach(input => {
            const row = input.closest('div.flex.flex-col.sm\\:flex-row');
            const discounted_price = parseFloat(row.querySelector('.hidden.sm\\:flex.justify-center.w-24')?.innerText.replace('','') || 0);
            const qty = parseInt(input.value);
            const totalCell = row.querySelector('.item-total');
            if(totalCell) totalCell.innerText = '' + (discounted_price * qty).toFixed(2);
            grandTotal += discounted_price * qty;
        });
        document.getElementById('grandTotal').innerText = '' + grandTotal.toFixed(2);
        const extraFee = 250; // fixed fee
        document.getElementById('grandTotalFinal').innerText = '' + (grandTotal + extraFee).toFixed(2);
    }

    cartItems.forEach(input => {
        const productId = input.dataset.productId;

        input.addEventListener('change', () => {
            if(input.value < 1) input.value = 1;
            updateTotals();
            fetch(`/update/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type':'application/json',
                    'X-CSRFToken':'{{ csrf_token }}'
                },
                body: JSON.stringify({ quantity: input.value })
            });
        });

        const parent = input.parentElement;
        parent.querySelector('.increase').addEventListener('click', () => {
            input.value = parseInt(input.value) + 1;
            input.dispatchEvent(new Event('change'));
        });

        parent.querySelector('.decrease').addEventListener('click', () => {
            if(input.value > 1) input.value = parseInt(input.value) - 1;
            input.dispatchEvent(new Event('change'));
        });
    });

    updateTotals();
});
</script>

<script>
setTimeout(() => {
    const msg = document.getElementById('success-message');
    if(msg) msg.remove();
}, 4000);
</script>
